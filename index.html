<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Workstation</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --accent: #3b82f6; --green: #22c55e; --red: #ef4444; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media(max-width:800px){ .container{ grid-template-columns: 1fr; } }

        /* HEADER */
        .top-bar { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card); padding: 15px; border-radius: 10px; box-sizing: border-box; }
        .balance-display { font-size: 24px; font-weight: bold; color: var(--green); }
        .btn-main { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-main:hover { opacity: 0.9; }

        /* NAV */
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; width: 100%; max-width: 1200px; }
        .nav-btn { background: var(--card); border: 1px solid #334155; color: #94a3b8; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* PANELS */
        .panel { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid #334155; display: flex; flex-direction: column; gap: 15px; }
        
        .price-box { text-align: center; }
        .price-val { font-size: 42px; font-weight: 800; }
        .signal-badge { display: inline-block; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 18px; margin-top: 5px; }
        
        .chart-img { width: 100%; height: 250px; object-fit: contain; background: #020617; border-radius: 8px; }

        /* OPERATIONS PANEL */
        .ops-panel { background: #0f172a; border: 1px solid #334155; padding: 15px; border-radius: 8px; }
        .ops-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-group { display: flex; gap: 10px; }
        .op-input { background: #1e293b; border: 1px solid #475569; color: white; padding: 8px; border-radius: 4px; width: 100px; }
        .btn-buy { background: var(--green); color: black; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-sell { background: var(--red); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* CHAT */
        .chat-box { height: 350px; display: flex; flex-direction: column; background: #0f172a; border-radius: 8px; overflow: hidden; border: 1px solid #334155; }
        .chat-msgs { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; font-size: 13px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 85%; }
        .msg.bot { background: #1e3a8a; align-self: flex-start; color: #bfdbfe; }
        .msg.user { background: #334155; align-self: flex-end; }
        .chat-input { background: #1e293b; border: none; padding: 12px; color: white; width: 100%; box-sizing: border-box; outline: none; border-top: 1px solid #334155; }

        /* MODAL INICIO */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 12px; width: 300px; text-align: center; }
        .modal-input { width: 100%; padding: 10px; margin: 15px 0; background: #0f172a; border: 1px solid #475569; color: white; border-radius: 6px; font-size: 18px; text-align: center; }
    </style>
</head>
<body>

    <div id="startModal" class="modal">
        <div class="modal-content">
            <h2>üíº Iniciar Jornada</h2>
            <p>Ingresa tu saldo inicial en USDT</p>
            <input type="number" id="startBalance" class="modal-input" value="1000">
            <button class="btn-main" onclick="startDay()">Abrir Sistema</button>
        </div>
    </div>

    <div class="top-bar">
        <div>
            <span style="color:#94a3b8; font-size:12px">CAJA USDT</span><br>
            <span id="globalBalance" class="balance-display">$0.00</span>
        </div>
        <button class="btn-main" style="background:var(--red)" onclick="alert('Vende todo en Binance. Fin del d√≠a.')">Cerrar Jornada</button>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="changeSymbol('BTCUSDT', this)">Bitcoin</button>
        <button class="nav-btn" onclick="changeSymbol('ETHUSDT', this)">Ethereum</button>
        <button class="nav-btn" onclick="changeSymbol('SOLUSDT', this)">Solana</button>
        <button class="nav-btn" onclick="changeSymbol('BNBUSDT', this)">Binance</button>
        <button class="nav-btn" onclick="changeSymbol('ADAUSDT', this)">Cardano</button>
    </div>

    <div class="container">
        <div class="panel">
            <div class="price-box">
                <div style="color:#94a3b8; font-weight:bold" id="symTitle">BTC / USDT</div>
                <div class="price-val" id="price">---</div>
                <div class="signal-badge" id="signal">ESPERANDO...</div>
                <div id="reasons" style="font-size:12px; color:#94a3b8; margin-top:5px"></div>
            </div>

            <img id="chart" class="chart-img" src="" alt="Gr√°fico">

            <div class="ops-panel">
                <div class="ops-row">
                    <div>
                        <div style="font-size:12px; color:#94a3b8">POSICI√ìN ACTUAL</div>
                        <div style="font-size:18px; font-weight:bold; color:#fbbf24" id="myPos">0.0000</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:12px; color:#94a3b8">VALOR USD</div>
                        <div style="font-size:18px; font-weight:bold" id="myPosVal">$0.00</div>
                    </div>
                </div>

                <hr style="border-color:#334155; margin:15px 0">
                <div style="font-size:13px; margin-bottom:10px; color:#94a3b8">REGISTRAR OPERACI√ìN REALIZADA</div>
                
                <div class="input-group">
                    <input type="number" id="tradeAmount" class="op-input" placeholder="Cant.">
                    <input type="number" id="tradePrice" class="op-input" placeholder="Precio">
                    <button class="btn-buy" onclick="registerTrade('COMPRA')">COMPR√â</button>
                    <button class="btn-sell" onclick="registerTrade('VENTA')">VEND√ç</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div style="font-weight:bold; color:#94a3b8; margin-bottom:10px">ü§ñ Asesor IA</div>
            <div class="chat-box">
                <div class="chat-msgs" id="chatBody">
                    <div class="msg bot">Sistema listo. Esperando datos de mercado...</div>
                </div>
                <input type="text" class="chat-input" id="chatInput" placeholder="Consultar al asesor..." onkeypress="handleEnter(event)">
            </div>
        </div>
    </div>

    <script>
        let currentSymbol = 'BTCUSDT';
        let currentPrice = 0;

        async function startDay() {
            const bal = document.getElementById('startBalance').value;
            await fetch('/set_balance', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ usdt: bal })
            });
            document.getElementById('startModal').style.display = 'none';
            updateData();
        }

        function changeSymbol(sym, btn) {
            currentSymbol = sym;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('symTitle').innerText = sym.replace('USDT', ' / USDT');
            document.getElementById('price').innerText = "---";
            // Limpiar chat visualmente (o cargar historial si quisieras)
            document.getElementById('chatBody').innerHTML = '<div class="msg bot">Cambiando vista a '+sym+'...</div>';
            updateData();
        }

 async function updateData() {
            try {
                const res = await fetch(`/analisis?symbol=${currentSymbol}`);
                const data = await res.json();
                
                // MANEJO DE ERROR (Si Binance bloquea)
                if(data.error) {
                    document.getElementById('signal').innerText = "OFFLINE";
                    document.getElementById('signal').style.backgroundColor = "#ef4444";
                    document.getElementById('signal').style.color = "white";
                    document.getElementById('reasons').innerText = "Binance no responde. Reintentando...";
                    return; 
                }

                // SI TODO VA BIEN...
                currentPrice = data.precio;
                document.getElementById('price').innerText = "$" + currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2});
                
                // Se√±al
                const sigEl = document.getElementById('signal');
                sigEl.innerText = data.decision;
                let c = "#64748b";
                if(data.decision.includes("COMPRA")) c = "#22c55e";
                if(data.decision.includes("VENTA")) c = "#ef4444";
                sigEl.style.backgroundColor = c + "20";
                sigEl.style.color = c;
                
                document.getElementById('reasons').innerText = data.detalles.join(" | ");
                if(data.grafico) document.getElementById('chart').src = data.grafico;

                // Datos de Cartera
                const pf = data.portfolio;
                // Actualizamos saldo global de la UI (Caja USDT)
                // (Nota: el backend nos manda el pf individual, asumimos que el USDT es el global sincro)
                document.getElementById('globalBalance').innerText = "$" + pf.usdt.toLocaleString('en-US', {minimumFractionDigits: 2});
                
                // Posici√≥n Individual
                document.getElementById('myPos').innerText = pf.coin.toFixed(5);
                const posVal = pf.coin * currentPrice;
                document.getElementById('myPosVal').innerText = "$" + posVal.toLocaleString('en-US', {minimumFractionDigits: 2});
                
                // Prellenar inputs para facilitar
                document.getElementById('tradePrice').value = currentPrice;

            } catch(e) { console.error(e); }
        }

        async function registerTrade(action) {
            const amt = document.getElementById('tradeAmount').value;
            const prc = document.getElementById('tradePrice').value;
            if(!amt || !prc) return alert("Ingresa cantidad y precio real");

            const res = await fetch('/registrar_trade', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: currentSymbol,
                    action: action,
                    amount: amt,
                    price: prc
                })
            });
            const d = await res.json();
            if(d.status) {
                alert("Operaci√≥n registrada correctamente.");
                document.getElementById('tradeAmount').value = "";
                updateData(); // Refrescar saldos
            }
        }

        // Chat
        function handleEnter(e) { if(e.key === 'Enter') sendChat(); }
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const txt = input.value;
            if(!txt) return;
            
            const box = document.getElementById('chatBody');
            box.innerHTML += `<div class="msg user">${txt}</div>`;
            input.value = '';
            
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: txt, symbol: currentSymbol })
            });
            const d = await res.json();
            box.innerHTML += `<div class="msg bot">${d.reply}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        setInterval(updateData, 5000);
        // No llamamos updateData al inicio para esperar al Modal
    </script>
</body>
</html>